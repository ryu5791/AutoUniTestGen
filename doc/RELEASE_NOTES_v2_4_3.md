# AutoUniTestGen v2.4.3 リリースノート

**リリース日**: 2025-11-13  
**バージョン**: 2.4.3  
**重要度**: ⭐⭐⭐ (高)

---

## 🎯 このリリースの目的

**ビルドの簡素化**: 生成されたテストファイル単体でビルドを通せるようにし、ヘッダーファイルや元のソースファイルへの依存を排除します。

---

## ✨ 新機能

### 🔥 スタンドアロンモード（デフォルト有効）

**説明**:  
元のソースファイル全体にテストコード（モック関数、テスト関数、setUp/tearDown、main関数）を追加したスタンドアロン版を生成します。

**メリット**:
- ✅ **ビルドが簡単**: 生成されたファイル単体でコンパイル可能
- ✅ **依存関係の削減**: 元のソースファイルやヘッダーファイルへの依存を最小化
- ✅ **可搬性の向上**: 1つのファイルで完結するため、共有や移動が容易

**生成されるファイル構造**:
```c
// 元のソースファイルの内容（すべて）
#include <...>
#define ...
typedef ...
void original_function() {
    // 元の関数本体
}

================================================================================
/* 以下、自動生成されたテストコード */
================================================================================

#include "unity.h"

// ===== モック変数とモック関数 =====
// ...

// ===== テスト関数群 =====
void test_case_1(void) {
    // テストコード
}

// ===== setUp/tearDown =====
void setUp(void) { ... }
void tearDown(void) { ... }

// ===== main関数 =====
int main(void) {
    UNITY_BEGIN();
    // テスト実行
    return UNITY_END();
}
```

---

## 🔧 技術的変更

### 1. `UnityTestGenerator` クラスの拡張

**新規メソッド**: `generate_standalone()`

```python
def generate_standalone(self, truth_table: TruthTableData, 
                       parsed_data: ParsedData, 
                       source_code: str) -> str:
    """
    元のソースファイル全体にテストコードを追加したスタンドアロン版を生成
    
    Args:
        truth_table: 真偽表データ
        parsed_data: 解析済みデータ
        source_code: 元のソースコード全体
    
    Returns:
        str: スタンドアロンテストコード
    """
```

**ファイル**: `src/test_generator/unity_test_generator.py`

### 2. `CTestAutoGenerator` クラスの拡張

**新規フィールド**:
```python
self.standalone_mode = self.config.get('standalone_mode', True)  # デフォルトで有効
```

**変更箇所**:
- `__init__()`: `standalone_mode` フラグを追加
- `generate_all()`: スタンドアロンモード時の処理分岐を追加

**ファイル**: `src/c_test_auto_generator.py`

### 3. CLI オプションの追加

**新規オプション**: `--no-standalone`

```bash
# スタンドアロンモードを無効化（従来の方式）
python main.py -i input.c -f func --no-standalone
```

**ファイル**: `src/cli.py`

---

## 📋 使用方法

### スタンドアロンモード（デフォルト）

```bash
# 通常通り実行するだけ
python main.py -i 22_難読化_obfuscated.c -f Utf1 -o output

# 生成されるファイル:
# - test_22_難読化_obfuscated_Utf1.c  ← スタンドアロン版
# - 22_難読化_obfuscated_Utf1_truth_table.xlsx
# - 22_難読化_obfuscated_Utf1_io_table.xlsx
```

### ビルド方法

```bash
# Unity frameworkとリンクしてビルド
gcc -o test_prog \
    test_22_難読化_obfuscated_Utf1.c \
    unity.c \
    -I./Unity/src \
    -DUNITY_INCLUDE_DOUBLE

# 実行
./test_prog
```

### 従来の方式（スタンドアロンモード無効）

```bash
# --no-standaloneオプションを使用
python main.py -i input.c -f func --no-standalone -o output

# 従来通り、元のソースとテストコードが分離された形式で生成
```

---

## 📊 実行例

### 入力ファイル

```
/mnt/project/22_難読化_obfuscated.c  (約30KB)
```

### 生成結果

```
$ python main.py -i /mnt/project/22_難読化_obfuscated.c -f Utf1 -o /tmp/output

======================================================================
C言語単体テスト自動生成ツール v2.2
======================================================================

✅ 設定ファイルを読み込みました: config.ini
🎯 モード: すべて生成（真偽表、テストコード、I/O表）
🔍 Step 1/4: C言語ファイルを解析中...
   ✓ 解析完了: 0個の条件を検出
📊 Step 2/4: MC/DC真偽表を生成中...
   ✓ 真偽表生成完了: 0個のテストケース
🧪 Step 3/4: Unityテストコードを生成中...
   💡 スタンドアロンモード: 元のソースファイルにテストコードを追加します
   ✓ スタンドアロン版テストコード生成完了
📝 Step 4/4: I/O一覧表を生成中...
   ✓ I/O表生成完了: 0個のテストケース

✅ すべての生成処理が完了しました！
```

### 生成されたファイル

```
$ ls -lh /tmp/output/
total 46K
-rw-r--r-- 1 root root 5.0K Nov 13 09:09 22_難読化_obfuscated_Utf1_io_table.xlsx
-rw-r--r-- 1 root root 5.0K Nov 13 09:09 22_難読化_obfuscated_Utf1_truth_table.xlsx
-rw-r--r-- 1 root root  36K Nov 13 09:09 test_22_難読化_obfuscated_Utf1.c
```

---

## 🔍 生成されたファイルの構造

### スタンドアロン版（v2.4.3）

```
test_22_難読化_obfuscated_Utf1.c (36KB)
├─ 元のソースファイル全体 (1-2043行)
│  ├─ #include文
│  ├─ #define文
│  ├─ typedef文
│  ├─ グローバル変数
│  └─ 関数定義（Utf1関数を含む）
│
├─ 区切り線 (2045-2047行)
│  ================================================================================
│  /* 以下、自動生成されたテストコード */
│  ================================================================================
│
└─ テストコード (2049行～)
   ├─ #include "unity.h"
   ├─ モック変数とモック関数
   ├─ テスト関数群
   ├─ setUp/tearDown
   └─ main関数
```

---

## ⚠️ 既知の制限事項

### 1. フォールバックモード時の条件分岐抽出

**現象**:  
元のソースに前処理ディレクティブ（`#if`, `#ifdef` など）が残っている場合、AST解析が失敗し、フォールバックモードに入ります。この場合、条件分岐を抽出できないため、MC/DCテストケースが0個になります。

**影響**:
- 真偽表: 0個のテストケース
- I/O表: 0個のテストケース
- テストコード: setUp/tearDown と main関数のみ

**対処方法**:
今後のバージョン（v2.5.x）で対応予定：
- プリプロセッサ対応パーサーの導入（pcpp など）
- 正規表現ベースの条件分岐抽出

### 2. 複雑な依存関係

スタンドアロン版では元のソースファイル全体が含まれるため、以下のような依存関係は自動的に解決されます：
- ✅ 型定義
- ✅ マクロ定義
- ✅ グローバル変数
- ✅ static関数

ただし、外部ヘッダーファイルで定義された型やマクロは含まれないため、必要に応じて手動で追加してください。

---

## 📈 v2.4.2からの改善点

| 項目 | v2.4.2 | v2.4.3 |
|------|--------|--------|
| ビルドの簡単さ | ⚠️ 元のソースとヘッダーが必要 | ✅ 単一ファイルでビルド可能 |
| 可搬性 | ⚠️ 複数ファイルが必要 | ✅ 1ファイルで完結 |
| 生成ファイル | 型定義セクションに追加 | 元のソース全体 + テストコード |
| デフォルト動作 | 分離型 | スタンドアロン型 |

---

## 🎊 マイルストーン

### v2.4シリーズの達成状況

```
v2.4.0: [完了] 関数呼び出し対応
v2.4.1: [完了] 構造体メンバー対応
v2.4.2: [完了] 型定義とマクロ定義の抽出
v2.4.3: [完了] スタンドアロンモード実装 ← 今ここ！
```

### 全体の進捗: 90%

| Phase | 内容 | 状態 | 完了率 |
|-------|------|------|--------|
| Phase 1 | 基本設計 | ✅ 完了 | 100% |
| Phase 2 | パーサー実装 | ✅ 完了 | 100% |
| Phase 3 | 真偽表生成 | ✅ 完了 | 100% |
| Phase 4 | テストコード生成 | ✅ 完了 | 100% |
| Phase 5 | Excel出力 | ✅ 完了 | 100% |
| Phase 6 | 統合とテスト | ✅ 完了 | 100% |
| Phase 7 | 改善と最適化 | 🔶 進行中 | 90% |

---

## 🔮 次のバージョン (v2.5.x)

### 計画中の機能

1. **条件分岐の抽出（フォールバックモード対応）**
   - プリプロセッサ対応パーサーの導入
   - MC/DCテストケースの生成

2. **関数プロトタイプの自動抽出**
   - 正規表現ベースの関数宣言抽出
   - 戻り値と引数の自動推定

3. **ビルドスクリプトの自動生成**
   - Makefileの自動生成
   - CMakeLists.txtの自動生成

---

## 🐛 バグ修正

なし（v2.4.2からの新機能追加のみ）

---

## 📚 ドキュメント

- リリースノート: `RELEASE_NOTES_v2_4_3.md`
- 引き継ぎドキュメント: 更新予定
- バージョン: `VERSION` (2.4.3)

---

## 🙏 謝辞

v2.4.3リリースにあたり、以下の点を改善しました：

- ✅ ビルドの簡素化
- ✅ ファイル管理の簡素化
- ✅ 可搬性の向上

次のバージョンでは、フォールバックモードでのMC/DCテストケース生成に注力します。

---

**リリース担当**: ichiryu  
**リリース日**: 2025-11-13  
**次回リリース予定**: v2.5.0 (条件分岐抽出対応)
