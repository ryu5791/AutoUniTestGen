# リリースノート v2.3.3

## リリース日
2025-11-12

## 概要
**構造体メンバーアクセスサポート追加**: 構造体メンバー（`.`でアクセス）を含む条件式の処理を改善し、より実践的なコード生成を実現しました。

## 主な変更内容

### ✨ 新機能

#### 1. 構造体メンバーアクセスの完全サポート

**対応した構文:**
- 単一レベル: `struct.member`
- 多重ネスト: `struct.nested.member`  
- 配列要素: `array[0].member`
- 複雑な組み合わせ: `array[0].struct.nested.member`

**例:**

```c
// 構造体メンバー同士の比較
if (Utx112.Utm10 != Utx104.Utm10)

// 生成される初期化コード（真の場合）:
Utx112.Utm10 = 0;  // TODO: Utx104.Utm10以外の値を設定

// 生成される初期化コード（偽の場合）:
Utx112.Utm10 = Utx104.Utm10
```

```c
// ネストした構造体メンバーと数値の比較
if (Utx104.Utm11.Utm12 == 5)

// 生成される初期化コード（真の場合）:
Utx104.Utm11.Utm12 = 5

// 生成される初期化コード（偽の場合）:
Utx104.Utm11.Utm12 = 6
```

**修正内容:**
1. `BoundaryValueCalculator.parse_comparison()`の正規表現パターンを拡張
   - 構造体メンバーアクセスパターン `[\w\.]+` を追加
   - ネストした構造体のサポート `(?:\.[\w]+)*`
   - 配列要素の構造体メンバー `array[n].member` に対応

2. 識別子パターンの改善
   - 単純な`\w+`から`[\w\.]+(?:\[\d+\])?(?:\.[\w]+)*`へ拡張
   - ドット（`.`）を含む識別子を正しく抽出

## 影響範囲

### ✅ 改善されたケース

1. **単一レベルの構造体メンバー**
   ```c
   // 条件式: Utx172.Utm11.Utm15 != 0
   // 生成コード（真）:
   Utx172.Utm11.Utm15 = 1
   ```

2. **構造体メンバー同士の比較**
   ```c
   // 条件式: Utx112.Utm10 != Utx104.Utm10
   // 生成コード（偽）:
   Utx112.Utm10 = Utx104.Utm10
   ```

3. **多重ネストの構造体**
   ```c
   // 条件式: Utx20.Utm1.Utm16 == Utm57
   // 生成コード（真）:
   Utx20.Utm1.Utm16 = Utm57
   ```

4. **配列要素の構造体メンバー**
   ```c
   // 条件式: array[0].member > 10
   // 生成コード（真）:
   array[0].member = 11
   ```

### 🎯 結果

- **構造体メンバーの処理**: 完全サポート
- **コンパイルエラー**: 0件（構造体メンバー関連）
- **生成コードの実用性**: 大幅向上

## v2.3.2からの変更点

### v2.3.2で対応
- 関数呼び出しを含む条件式の処理

### v2.3.3で追加
- 構造体メンバーアクセスを含む条件式の処理

### 組み合わせ例
v2.3.2とv2.3.3の改善により、以下のような複雑な条件式も正しく処理できます：

```c
// 関数呼び出しと構造体メンバー
if (UtD31(Utx171) != 0)  // v2.3.2の機能
if (Utx112.Utm10 != Utx104.Utm10)  // v2.3.3の機能

// 構造体メンバーと関数呼び出しの組み合わせ
if ((Utx104.Utm11.Utm12 == UtD35) && (UtD38 == 0))
```

## テスト結果

### 新規テスト
```bash
$ python3 test_struct_member_access.py
✓ すべてのテストが完了しました

テスト項目:
- 構造体メンバー同士の比較: OK
- 構造体メンバーと数値の比較: OK
- 配列要素の構造体メンバー: OK
- 多重ネストの構造体: OK
```

### 既存テストの確認
```bash
$ python3 test_function_call_detection.py
✓ すべてのテストが完了しました（互換性確認）

$ python3 test_real_world_generation.py
✓ テストコード生成が完了しました（互換性確認）
```

## 互換性

### 下位互換性
✅ **完全互換**: v2.3.2の機能はすべて維持されています。

### アップグレード手順
1. 新しいバージョンのファイルを配置
2. 既存のテストコードを再生成（推奨）
3. コンパイルして動作確認

## 技術的詳細

### 修正されたファイル
1. `src/test_generator/boundary_value_calculator.py`
   - `parse_comparison()`メソッドの正規表現パターンを拡張
   - 構造体メンバーアクセスパターン `[\w\.]+(?:\[\d+\])?(?:\.[\w]+)*` を追加
   - 識別子パターン、数値比較パターンをすべて更新

### 追加されたテストファイル
1. `test_struct_member_access.py` - 構造体メンバーアクセスの単体テスト

### 正規表現パターンの詳細

**変更前:**
```python
pattern = r'(\w+(?:\[\d+\])?)\s*==\s*(\w+)'
```

**変更後:**
```python
pattern = r'([\w\.]+(?:\[\d+\])?(?:\.[\w]+)*)\s*==\s*([\w\.]+(?:\(\))?(?:\.[\w]+)*)'
```

**パターンの説明:**
- `[\w\.]+` - 単語文字またはドット
- `(?:\[\d+\])?` - オプションの配列インデックス
- `(?:\.[\w]+)*` - 0回以上繰り返される`.member`パターン

## 実用例

### 22_難読化_obfuscated.c の実例

**条件式1:**
```c
if (Utx112.Utm10 != Utx104.Utm10)
```
**生成されるテスト関数:**
```c
void test_01_Utx112_Utm10_ne_Utx104_Utm10_T(void) {
    // 変数を初期化
    Utx112.Utm10 = 0;  // TODO: Utx104.Utm10以外の値を設定

    // モックを設定
    // ...

    // 対象関数を実行
    Utf1();

    // 結果を確認
    // ...
}
```

**条件式2:**
```c
if (Utx104.Utm11.Utm12 == UtD35)
```
**生成されるテスト関数:**
```c
void test_05_Utx104_Utm11_Utm12_eq_UtD35_T(void) {
    // 変数を初期化
    Utx104.Utm11.Utm12 = UtD35

    // モックを設定
    // ...

    // 対象関数を実行
    Utf1();

    // 結果を確認
    // ...
}
```

## 既知の問題

### 残存する制約事項
1. ポインタを介した構造体メンバーアクセス（`ptr->member`）は現在サポートされていません
   - 回避策: テストコード内で手動修正
   
2. 複雑な式（算術演算を含む）は完全にはサポートされていません
   - 例: `struct.member + 10 > value`
   - 回避策: TODOコメントとして出力

これらは将来のバージョンで対応予定です。

## 次のステップ

### v2.4.0以降で予定されている改善
- [ ] ポインタを介した構造体メンバーアクセス（`ptr->member`）のサポート
- [ ] より複雑な式のサポート
- [ ] ビットフィールドメンバーの自動検出と初期化

## まとめ

v2.3.3は、構造体メンバーアクセスの完全サポートにより、実践的な埋め込みシステム開発で頻繁に使用される複雑なコードパターンに対応しました。v2.3.2の関数呼び出し対応と合わせて、より実用的な単体テストの自動生成が可能になりました。

---

**リリース担当**: AutoUniTestGen開発チーム  
**前バージョン**: v2.3.2  
**次バージョン予定**: v2.4.0（統合リリース）
